{{ define "patient.html" }}
<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>گفت‌وگوی بیمار</title>
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <style>
      body { font-family: sans-serif; font-size: 1.2rem; line-height: 1.6; direction: rtl; background:#f0f4f8; }
      .chat-box { max-width: 600px; margin: 2rem auto; padding: 1rem; background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
      .messages { height: 60vh; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; background: #fafafa; border-radius:4px; }
      .message { margin-bottom: .5rem; padding:.5rem .75rem; border-radius:6px; max-width:90%; }
      .message.bot { background:#e7f1ff; color:#0a558d; }
      .message.patient { background:#e6f5ec; color:#0a843a; text-align: right; margin-left:auto; }
      input[type="text"] { width: 100%; padding: .5rem; font-size: 1rem; border:1px solid #ccc; border-radius:4px; }
      button { margin-top:.5rem; padding:.5rem 1rem; font-size:1rem; background:#0a558d; color:#fff; border:none; border-radius:4px; cursor:pointer; }
      button:disabled { background:#999; cursor:not-allowed; }
    </style>
</head>
<body>
  <div class="chat-box" hx-boost="true">
    <h1>گفت‌وگوی بیمار</h1>
    <div id="messages" class="messages">
      {{ range .Transcript }}
      <div class="message {{ .Role }}">{{ .Content }}</div>
      {{ end }}
    </div>
      <form id="chat-form" hx-post="/api/users/{{ .NationalID }}/messages" hx-swap="beforeend" hx-target="#messages" hx-disabled-elt="#send-btn" hx-on::after-request="this.reset()" hx-on::before-request="appendUserMessage(this)">
        <input name="content" type="text" autocomplete="off" placeholder="پیام خود را بنویسید" onkeydown="if(event.key==='Enter'){this.form.requestSubmit();event.preventDefault();}" />
        <button id="send-btn" type="submit">ارسال</button>
      </form>
  </div>
    <script>
      // Auto scroll to bottom on new messages
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target.id === 'messages') {
          evt.target.scrollTop = evt.target.scrollHeight;
        }
      });

      function appendUserMessage(form){
        var input = form.querySelector('input[name="content"]');
        var text = input.value.trim();
        if(text === ''){ return; }
        var msgs = document.getElementById('messages');
        var div = document.createElement('div');
        div.className = 'message patient';
        div.textContent = text;
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
      }

      document.getElementById('chat-form').addEventListener('htmx:sendError', function(){
        var btn = document.getElementById('send-btn');
        btn.disabled = true;
        setTimeout(function(){ btn.disabled = false; }, 5000);
      });
    </script>
</body>
</html>
{{ end }}

{{ define "patient" }}
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>گفت‌وگوی بیمار</title>
  <script src="https://unpkg.com/htmx.org@1.9.4"></script>
  <style>
    body { font-family: sans-serif; font-size: 1.1rem; background:#fafafa; margin:0; }
    .wrap { max-width:720px; margin:0 auto; padding:1rem; }
    .messages { display:flex; flex-direction:column; gap:.5rem; padding-bottom:6rem; }
    .msg { max-width:85%; padding:.6rem .8rem; border-radius:12px; line-height:1.6; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.06); }
    .msg.patient { background:#e8f4ff; align-self:flex-start; }
    .msg.bot { background:#f1f1f1; align-self:flex-end; }
    .msg.error { background:#ffe9e9; border:1px solid #f3b3b3; color:#b00000; }
    .composer { position:fixed; right:0; left:0; bottom:0; background:#fff; border-top:1px solid #eee; }
    .composer .inner { max-width:720px; margin:0 auto; display:flex; gap:.5rem; padding:.6rem; }
    input[type=text] { flex:1; padding:.6rem .8rem; font-size:1.05rem; border:1px solid #ddd; border-radius:10px; }
    button { min-width:96px; padding:.6rem .9rem; border:0; border-radius:10px; font-size:1rem; background:#0b74de; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .spinner { display:none; margin-inline-start:.5rem; }
    .htmx-request .spinner { display:inline-block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="messages" class="messages">
      {{ range .Transcript }}
        <div class="msg {{ .Role }}">{{ .Content }}</div>
      {{ end }}
    </div>

    <form id="chatForm"
          class="composer"
          hx-post="/api/users/{{ .SessionID }}/messages"
          hx-trigger="submit"
          hx-target="#messages"
          hx-swap="beforeend"
          hx-disabled-elt="#sendBtn"
          hx-vals='js:{ content: document.getElementById("inputMsg").value }'
          hx-on::before-request="window.__lastMsg = inputMsg.value; appendPatientBubble(); inputMsg.value='';"
          hx-on::after-request="scrollToBottom();">

      <div class="inner">
        <input id="inputMsg" type="text" name="content" autocomplete="off" required placeholder="پیام خود را بنویسید…" />
        <button id="sendBtn" type="submit">ارسال</button>
        <span class="spinner">…</span>
      </div>
    </form>
  </div>

  <script>
    function scrollToBottom() {
      const list = document.getElementById('messages');
      list.lastElementChild?.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
    function appendPatientBubble() {
      const txt = (window.__lastMsg || '').trim();
      if (!txt) return;
      const div = document.createElement('div');
      div.className = 'msg patient';
      div.textContent = txt;
      document.getElementById('messages').appendChild(div);
    }

    // Error handling: keep patient bubble (already appended) and show an error bubble
    document.body.addEventListener('htmx:responseError', function (e) {
      const err = document.createElement('div');
      err.className = 'msg bot error';
      err.textContent = 'خطا در پاسخ‌دهی. لطفاً دوباره تلاش کنید.';
      document.getElementById('messages').appendChild(err);
      scrollToBottom();
    });
    document.body.addEventListener('htmx:sendError', function (e) {
      const err = document.createElement('div');
      err.className = 'msg bot error';
      err.textContent = 'ارتباط برقرار نشد. اینترنت را بررسی کنید و دوباره تلاش کنید.';
      document.getElementById('messages').appendChild(err);
      scrollToBottom();
    });

    // Scroll to the latest message on initial load
    scrollToBottom();
  </script>
</body>
</html>
{{ end }}